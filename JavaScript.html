<!-- JavaScript.html -->
<script>
// =================== GLOBAL VARIABLES ===================
let currentUser = null;
let currentPage = 'dashboard';
let accounts = [];
let categories = [];
let transactions = [];
let customers = [];
let suppliers = [];

// =================== ENHANCED ERROR HANDLING ===================
window.addEventListener('error', function(event) {
    console.error('‚ùå Global JavaScript error:', {
        message: event.message,
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno,
        error: event.error
    });
    showNotification('ƒê√£ x·∫£y ra l·ªói h·ªá th·ªëng. Vui l√≤ng l√†m m·ªõi trang.', 'error');
});

window.addEventListener('unhandledrejection', function(event) {
    console.error('‚ùå Unhandled promise rejection:', event.reason);
    showNotification('ƒê√£ x·∫£y ra l·ªói h·ªá th·ªëng. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
});

// =================== INITIALIZATION ===================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM loaded, initializing NHT Finance System...');
    
    try {
        // Initialize event listeners first
        initializeEventListeners();
        console.log('‚úÖ Event listeners initialized');
        
        // Check authentication status
        checkAuthStatus();
        console.log('‚úÖ Auth check completed');
        
    } catch (error) {
        console.error('‚ùå Critical error during initialization:', error);
        
        // Show critical error message
        document.body.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; font-family: Arial, sans-serif;">
                <h1 style="color: #dc3545; margin-bottom: 20px;">‚ö†Ô∏è L·ªói kh·ªüi t·∫°o</h1>
                <p style="color: #666; margin-bottom: 20px;">Kh√¥ng th·ªÉ kh·ªüi t·∫°o ·ª©ng d·ª•ng. Vui l√≤ng l√†m m·ªõi trang.</p>
                <button onclick="window.location.reload()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    L√†m m·ªõi trang
                </button>
                <p style="color: #999; font-size: 12px; margin-top: 20px;">Chi ti·∫øt l·ªói: ${error.message}</p>
            </div>
        `;
    }
});

function checkAuthStatus() {
    // Thay localStorage b·∫±ng session storage t·∫°m th·ªùi
    const savedUser = sessionStorage.getItem('nht_current_user');
    if (savedUser) {
        try {
            currentUser = JSON.parse(savedUser);
            console.log('‚úÖ User found in sessionStorage:', currentUser);
            hideLoginModal();
            initializeApp();
        } catch (error) {
            console.error('‚ùå Error parsing saved user:', error);
            showLoginModal();
        }
    } else {
        console.log('‚ÑπÔ∏è No saved user, showing login modal');
        showLoginModal();
    }
}

function initializeApp() {
    console.log('üéØ Initializing app for user:', currentUser?.username);
    
    try {
        updateUserDisplay();
        
        // Load real data instead of dummy data
        loadDashboardData();
        
        showNotification('ƒêƒÉng nh·∫≠p th√†nh c√¥ng! Ch√†o m·ª´ng ' + (currentUser?.fullName || currentUser?.username), 'success');
        
    } catch (error) {
        console.error('‚ùå Error initializing app:', error);
        showNotification('C√≥ l·ªói x·∫£y ra khi kh·ªüi t·∫°o ·ª©ng d·ª•ng', 'error');
    }
}

function loadPageData(pageId) {
    showLoading('ƒêang t·∫£i d·ªØ li·ªáu...');
    
    switch(pageId) {
        case 'dashboard':
            loadDashboardData();
            break;
        case 'transactions':
            loadRealTransactions().then(() => {
                hideLoading();
                displayTransactions();
            }).catch(error => {
                hideLoading();
                console.error('Error loading transactions:', error);
            });
            break;
        case 'accounts':
            loadRealAccounts().then(() => {
                hideLoading();
                displayAccounts();
            }).catch(error => {
                hideLoading();
                console.error('Error loading accounts:', error);
            });
            break;
        case 'categories':
            loadRealCategories().then(() => {
                hideLoading();
                displayCategories();
            }).catch(error => {
                hideLoading();
                console.error('Error loading categories:', error);
            });
            break;
        case 'customers':
            loadRealCustomers().then(() => {
                hideLoading();
                displayCustomers();
            }).catch(error => {
                hideLoading();
                console.error('Error loading customers:', error);
            });
            break;
        case 'suppliers':
            loadRealSuppliers().then(() => {
                hideLoading();
                displaySuppliers();
            }).catch(error => {
                hideLoading();
                console.error('Error loading suppliers:', error);
            });
            break;
        default:
            hideLoading();
    }
}

// =================== ERROR HANDLING FOR GOOGLE APPS SCRIPT ===================
function handleGoogleScriptError(error) {
    console.error('Google Apps Script Error:', error);
    
    if (error.message && error.message.includes('timeout')) {
        showNotification('K·∫øt n·ªëi b·ªã timeout. Vui l√≤ng th·ª≠ l·∫°i.', 'warning');
    } else if (error.message && error.message.includes('permission')) {
        showNotification('Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p. Vui l√≤ng li√™n h·ªá admin.', 'error');
    } else {
        showNotification('C√≥ l·ªói x·∫£y ra v·ªõi server. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
    }
}

// Override c√°c function c≈© ƒë·ªÉ kh√¥ng d√πng dummy data n·ªØa
function loadDummyData() {
    console.log('üîÑ Redirecting to load real data instead of dummy data');
    loadDashboardData();
}

console.log('üéâ Real authentication system loaded successfully!');
console.log('üì° Connected to Google Apps Script backend');
console.log('üë• Ready to authenticate with real user accounts');

// =================== EVENT LISTENERS ===================
function initializeEventListeners() {
    console.log('üîó Setting up event listeners...');
    
    try {
        // Login form
        const loginForm = document.getElementById('login-form');
        if (loginForm) {
            loginForm.addEventListener('submit', handleLogin);
            console.log('‚úÖ Login form event listener added');
        }
        
        // Sidebar navigation
        document.querySelectorAll('.sidebar-menu li').forEach(item => {
            item.addEventListener('click', function() {
                const page = this.getAttribute('data-page');
                if (page) {
                    changePage(page);
                }
            });
        });
        console.log('‚úÖ Sidebar navigation event listeners added');
        
        // Sidebar collapse
        const collapseBtn = document.getElementById('collapse-sidebar');
        if (collapseBtn) {
            collapseBtn.addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('collapsed');
            });
        }
        
        // User menu toggle
        const userMenuToggle = document.getElementById('user-menu-toggle');
        if (userMenuToggle) {
            userMenuToggle.addEventListener('click', toggleUserMenu);
        }
        
        // Logout button
        const logoutBtn = document.getElementById('logout-button');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', handleLogout);
        }
        
        // Add transaction button
        const addTransactionBtn = document.getElementById('add-transaction-btn');
        if (addTransactionBtn) {
            addTransactionBtn.addEventListener('click', showAddTransactionModal);
            console.log('‚úÖ Add transaction button event listener added');
        }
        
        // Transaction form
        const transactionForm = document.getElementById('transaction-form');
        if (transactionForm) {
            transactionForm.addEventListener('submit', handleTransactionSubmit);
        }
        
        // Modal close buttons
        document.querySelectorAll('.close, .cancel-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const modal = this.closest('.modal');
                if (modal && modal.id !== 'login-modal') {
                    hideModal(modal.id);
                }
            });
        });
        
        // Click outside modal to close
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal') && event.target.id !== 'login-modal') {
                hideModal(event.target.id);
            }
        });
        
        console.log('‚úÖ All event listeners set up successfully');
        
    } catch (error) {
        console.error('‚ùå Error setting up event listeners:', error);
    }
}

// =================== AUTHENTICATION ===================
function handleLogin(event) {
    event.preventDefault();
    
    console.log('üîê Handling real authentication...');
    
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value.trim();
    const errorElement = document.getElementById('login-error');
    
    // Clear previous error
    if (errorElement) {
        errorElement.style.display = 'none';
        errorElement.textContent = '';
    }
    
    // Validate inputs
    if (!username || !password) {
        showLoginError('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n ƒëƒÉng nh·∫≠p v√† m·∫≠t kh·∫©u');
        return;
    }
    
    // Show loading
    showLoading('ƒêang x√°c th·ª±c t√†i kho·∫£n...');
    
    // Call Google Apps Script authentication
    google.script.run
        .withSuccessHandler(function(result) {
            hideLoading();
            console.log('Authentication result:', result);
            
            if (result.success) {
                console.log('‚úÖ Login successful for user:', result.user.username);
                
                // Save user data
                currentUser = result.user;
                
                // Save to sessionStorage
                try {
                    sessionStorage.setItem('nht_current_user', JSON.stringify(currentUser));
                    console.log('‚úÖ User saved to sessionStorage');
                } catch (storageError) {
                    console.warn('‚ö†Ô∏è SessionStorage not available, using memory only');
                }
                
                // Hide login modal and initialize app
                hideLoginModal();
                initializeApp();
                
            } else {
                console.log('‚ùå Login failed:', result.message);
                showLoginError(result.message || 'T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng');
            }
        })
        .withFailureHandler(function(error) {
            hideLoading();
            console.error('‚ùå Authentication error:', error);
            showLoginError('C√≥ l·ªói x·∫£y ra khi ƒëƒÉng nh·∫≠p. Vui l√≤ng th·ª≠ l·∫°i.');
        })
        .authenticateUser(username, password);
}
function handleLogout() {
    console.log('üö™ Logging out...');
    
    currentUser = null;
    sessionStorage.removeItem('nht_current_user');
    
    // Reset UI
    document.getElementById('username-display').textContent = 'User';
    document.getElementById('user-avatar').textContent = 'U';
    
    // Clear data
    transactions = [];
    accounts = [];
    categories = [];
    customers = [];
    suppliers = [];
    
    // Show login modal
    showLoginModal();
    showNotification('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!', 'info');
}

function updateUserDisplay() {
    if (!currentUser) return;
    
    try {
        // Update username display
        const usernameDisplay = document.getElementById('username-display');
        if (usernameDisplay) {
            usernameDisplay.textContent = currentUser.fullName || currentUser.username;
        }
        
        // Update user avatar
        const userAvatar = document.getElementById('user-avatar');
        if (userAvatar) {
            const firstLetter = (currentUser.fullName || currentUser.username).charAt(0).toUpperCase();
            userAvatar.textContent = firstLetter;
        }
        
        console.log('‚úÖ User display updated:', currentUser.username);
    } catch (error) {
        console.error('‚ùå Error updating user display:', error);
    }
}

function showLoginError(message) {
    const errorElement = document.getElementById('login-error');
    if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
    }
}

// Loading functions
function showLoading() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.style.display = 'flex';
    }
}

function hideLoading() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

// =================== NAVIGATION ===================
function changePage(pageId) {
    console.log('üìÑ Changing to page:', pageId);
    
    // Update active sidebar item
    document.querySelectorAll('.sidebar-menu li').forEach(item => {
        item.classList.remove('active');
    });
    const activeItem = document.querySelector(`[data-page="${pageId}"]`);
    if (activeItem) {
        activeItem.classList.add('active');
    }
    
    // Show page
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.classList.add('active');
    }
    
    // Update page title
    const titles = {
        'dashboard': 'Dashboard',
        'transactions': 'Qu·∫£n l√Ω giao d·ªãch',
        'accounts': 'Qu·∫£n l√Ω t√†i kho·∫£n',
        'categories': 'Qu·∫£n l√Ω danh m·ª•c',
        'customers': 'Qu·∫£n l√Ω kh√°ch h√†ng',
        'suppliers': 'Qu·∫£n l√Ω nh√† cung c·∫•p',
        'reports': 'B√°o c√°o t√†i ch√≠nh',
        'settings': 'C√†i ƒë·∫∑t h·ªá th·ªëng'
    };
    
    const pageTitle = document.getElementById('page-title');
    if (pageTitle) {
        pageTitle.textContent = titles[pageId] || 'Dashboard';
    }
    
    currentPage = pageId;
    
    // Load page-specific data
    loadPageData(pageId);
}

function loadPageData(pageId) {
    switch(pageId) {
        case 'dashboard':
            loadDashboardData();
            break;
        case 'transactions':
            displayTransactions();
            break;
        case 'accounts':
            displayAccounts();
            break;
        case 'categories':
            displayCategories();
            break;
        case 'customers':
            displayCustomers();
            break;
        case 'suppliers':
            displaySuppliers();
            break;
    }
}

// =================== MODAL FUNCTIONS ===================
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        console.log('‚úÖ Modal shown:', modalId);
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
        console.log('‚úÖ Modal hidden:', modalId);
    }
}

function showLoginModal() {
    const modal = document.getElementById('login-modal');
    if (modal) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }
}

function hideLoginModal() {
    const modal = document.getElementById('login-modal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
        console.log('‚úÖ Login modal hidden successfully');
    }
}

function showAddTransactionModal() {
    console.log('üí∞ Opening add transaction modal...');
    
    try {
        // Reset form
        const form = document.getElementById('transaction-form');
        if (form) {
            form.reset();
        }
        
        // Set default values
        const dateInput = document.getElementById('transaction-date');
        if (dateInput) {
            dateInput.valueAsDate = new Date();
        }
        
        // Load fresh data for dropdowns
        Promise.all([
            loadAccounts(),
            loadCategories()
        ]).then(() => {
            console.log('‚úÖ Dropdowns populated');
            
            // Show modal
            showModal('transaction-modal');
            
        }).catch(error => {
            console.error('‚ùå Error loading dropdown data:', error);
            showNotification('C√≥ l·ªói khi t·∫£i d·ªØ li·ªáu form', 'error');
        });
        
    } catch (error) {
        console.error('‚ùå Error opening transaction modal:', error);
        showNotification('C√≥ l·ªói x·∫£y ra khi m·ªü form th√™m giao d·ªãch', 'error');
    }
}

// =================== TRANSACTION HANDLING ===================
function handleTransactionSubmit(event) {
    event.preventDefault();
    
    console.log('üíæ Handling real transaction submit...');
    
    try {
        // Collect form data
        const formData = {
            date: document.getElementById('transaction-date').value,
            type: document.getElementById('transaction-type').value,
            category: document.getElementById('transaction-category').value,
            amount: parseFloat(document.getElementById('transaction-amount').value) || 0,
            account: document.getElementById('transaction-source-account').value,
            note: document.getElementById('transaction-note').value || ''
        };
        
        // Validate data
        if (!formData.date || !formData.type || !formData.category || formData.amount <= 0 || !formData.account) {
            showNotification('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc', 'error');
            return;
        }
        
        console.log('üìù Transaction data:', formData);
        
        // Show loading
        showLoading('ƒêang l∆∞u giao d·ªãch...');
        
        // Call Google Apps Script to save transaction
        google.script.run
            .withSuccessHandler(function(result) {
                hideLoading();
                
                if (result.success) {
                    // Hide modal
                    hideModal('transaction-modal');
                    
                    // Reload data
                    loadDashboardData();
                    if (currentPage === 'transactions') {
                        loadPageData('transactions');
                    }
                    
                    // Show success message
                    showNotification('Th√™m giao d·ªãch th√†nh c√¥ng!', 'success');
                    
                    // Clear form
                    document.getElementById('transaction-form').reset();
                    
                } else {
                    showNotification('L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ l∆∞u giao d·ªãch'), 'error');
                }
            })
            .withFailureHandler(function(error) {
                hideLoading();
                console.error('‚ùå Error saving transaction:', error);
                showNotification('C√≥ l·ªói x·∫£y ra khi l∆∞u giao d·ªãch', 'error');
            })
            .addTransaction(formData);
        
    } catch (error) {
        hideLoading();
        console.error('‚ùå Error handling transaction submit:', error);
        showNotification('C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω form', 'error');
    }
}

// =================== DATA LOADING FUNCTIONS ===================
function loadDashboardData() {
    console.log('üìä Loading real dashboard data...');
    
    showLoading('ƒêang t·∫£i d·ªØ li·ªáu dashboard...');
    
    // Load all data from Google Apps Script
    Promise.all([
        loadRealTransactions(),
        loadRealAccounts(), 
        loadRealCategories()
    ]).then(() => {
        hideLoading();
        updateDashboardStats();
        displayRecentTransactions();
        console.log('‚úÖ Dashboard data loaded successfully');
    }).catch(error => {
        hideLoading();
        console.error('‚ùå Error loading dashboard data:', error);
        showNotification('C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu', 'error');
    });
}

function loadRealTransactions() {
    return new Promise((resolve, reject) => {
        google.script.run
            .withSuccessHandler(function(result) {
                transactions = result || [];
                console.log('‚úÖ Loaded transactions:', transactions.length);
                resolve(transactions);
            })
            .withFailureHandler(function(error) {
                console.error('‚ùå Error loading transactions:', error);
                reject(error);
            })
            .getTransactions();
    });
}

function loadRealAccounts() {
    return new Promise((resolve, reject) => {
        google.script.run
            .withSuccessHandler(function(result) {
                accounts = result || [];
                console.log('‚úÖ Loaded accounts:', accounts.length);
                populateAccountDropdown();
                resolve(accounts);
            })
            .withFailureHandler(function(error) {
                console.error('‚ùå Error loading accounts:', error);
                reject(error);
            })
            .getAccounts();
    });
}

function loadRealCategories() {
    return new Promise((resolve, reject) => {
        google.script.run
            .withSuccessHandler(function(result) {
                categories = result || [];
                console.log('‚úÖ Loaded categories:', categories.length);
                populateCategoryDropdown();
                resolve(categories);
            })
            .withFailureHandler(function(error) {
                console.error('‚ùå Error loading categories:', error);
                reject(error);
            })
            .getCategories();
    });
}

function loadRealCustomers() {
    return new Promise((resolve, reject) => {
        google.script.run
            .withSuccessHandler(function(result) {
                customers = result || [];
                console.log('‚úÖ Loaded customers:', customers.length);
                resolve(customers);
            })
            .withFailureHandler(function(error) {
                console.error('‚ùå Error loading customers:', error);
                reject(error);
            })
            .getCustomers();
    });
}

function loadRealSuppliers() {
    return new Promise((resolve, reject) => {
        google.script.run
            .withSuccessHandler(function(result) {
                suppliers = result || [];
                console.log('‚úÖ Loaded suppliers:', suppliers.length);
                resolve(suppliers);
            })
            .withFailureHandler(function(error) {
                console.error('‚ùå Error loading suppliers:', error);
                reject(error);
            })
            .getSuppliers();
    });
}

function updateDashboardStats() {
    // Calculate totals
    const totalIncome = transactions
        .filter(t => t.type === 'Thu')
        .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
    
    const totalExpense = transactions
        .filter(t => t.type === 'Chi')
        .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
    
    const netProfit = totalIncome - totalExpense;
    const totalBalance = accounts.reduce((sum, acc) => sum + (parseFloat(acc.balance) || 0), 0);
    
    // Update UI
    updateElement('total-income', formatCurrency(totalIncome));
    updateElement('total-expense', formatCurrency(totalExpense));
    updateElement('net-profit', formatCurrency(netProfit));
    updateElement('total-balance', formatCurrency(totalBalance));
    
    // Update net profit color
    const netProfitElement = document.getElementById('net-profit');
    if (netProfitElement) {
        netProfitElement.className = `stat-value ${netProfit >= 0 ? 'income' : 'expense'}`;
    }
}

// =================== DATA DISPLAY FUNCTIONS ===================
function displayRecentTransactions() {
    const tbody = document.getElementById('recent-transactions-body');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (!transactions || transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center" style="padding: 40px; color: #666;">Ch∆∞a c√≥ giao d·ªãch n√†o</td></tr>';
        return;
    }
    
    // Get last 5 transactions
    const recentTransactions = transactions
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 5);
    
    recentTransactions.forEach(transaction => {
        const row = document.createElement('tr');
        const amountClass = transaction.type === 'Thu' ? 'income' : 'expense';
        
        row.innerHTML = `
            <td>${formatDate(transaction.date)}</td>
            <td><span class="badge ${transaction.type === 'Thu' ? 'badge-success' : 'badge-danger'}">${transaction.type}</span></td>
            <td class="${amountClass}">${formatCurrency(transaction.amount)}</td>
            <td>${transaction.account}</td>
            <td>${transaction.note || '-'}</td>
        `;
        tbody.appendChild(row);
    });
}

function displayTransactions() {
    const tbody = document.getElementById('transactions-table-body');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (!transactions || transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center" style="padding: 40px; color: #666;">Ch∆∞a c√≥ giao d·ªãch n√†o</td></tr>';
        return;
    }
    
    transactions.forEach(transaction => {
        const row = document.createElement('tr');
        const amountClass = transaction.type === 'Thu' ? 'income' : 'expense';
        
        row.innerHTML = `
            <td>${transaction.id}</td>
            <td>${formatDate(transaction.date)}</td>
            <td><span class="badge ${transaction.type === 'Thu' ? 'badge-success' : 'badge-danger'}">${transaction.type}</span></td>
            <td class="${amountClass}">${formatCurrency(transaction.amount)}</td>
            <td>${transaction.account}</td>
            <td>${transaction.note || '-'}</td>
            <td>
                <button class="btn btn-sm btn-secondary" onclick="editTransaction('${transaction.id}')" title="S·ª≠a">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteTransaction('${transaction.id}')" title="X√≥a">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function displayAccounts() {
    const accountsList = document.getElementById('accounts-list');
    if (!accountsList) return;
    
    if (!accounts || accounts.length === 0) {
        accountsList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Ch∆∞a c√≥ t√†i kho·∫£n n√†o</p>';
        return;
    }
    
    let html = '<div class="stats-grid">';
    accounts.forEach(account => {
        const balanceClass = (account.balance || 0) >= 0 ? 'income' : 'expense';
        html += `
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">${account.name}</div>
                    <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-wallet"></i>
                    </div>
                </div>
                <div class="stat-value ${balanceClass}">${formatCurrency(account.balance || 0)}</div>
            </div>
        `;
    });
    html += '</div>';
    
    accountsList.innerHTML = html;
}

function populateAccountDropdown() {
    const sourceAccountSelect = document.getElementById('transaction-source-account');
    if (!sourceAccountSelect) return;
    
    // Clear existing options except the first one (placeholder)
    sourceAccountSelect.innerHTML = '<option value="">-- Ch·ªçn t√†i kho·∫£n --</option>';
    
    // Add account options
    if (accounts && accounts.length > 0) {
        accounts.forEach(account => {
            const option = document.createElement('option');
            option.value = account.name;
            option.textContent = `${account.name} (${formatCurrency(account.balance || 0)})`;
            sourceAccountSelect.appendChild(option);
        });
    }
}

function populateCategoryDropdown() {
    const categorySelect = document.getElementById('transaction-category');
    if (!categorySelect) return;
    
    categorySelect.innerHTML = '<option value="">-- Ch·ªçn danh m·ª•c --</option>';
    
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.name;
        option.textContent = category.name;
        categorySelect.appendChild(option);
    });
}

function displayCategories() {
    const tbody = document.getElementById('categories-table-body');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (categories.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center" style="padding: 40px; color: #666;">Ch∆∞a c√≥ danh m·ª•c n√†o</td></tr>';
        return;
    }
    
    categories.forEach(category => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${category.name}</td>
            <td><span class="badge ${category.type === 'Thu' ? 'badge-success' : 'badge-danger'}">${category.type}</span></td>
            <td>${category.description || '-'}</td>
            <td>
                <button class="btn btn-sm btn-secondary" onclick="editCategory('${category.id}')" title="S·ª≠a">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteCategory('${category.id}')" title="X√≥a">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function displayCustomers() {
    const tbody = document.getElementById('customers-table-body');
    if (!tbody) return;
    
    tbody.innerHTML = '<tr><td colspan="5" class="text-center" style="padding: 40px; color: #666;">Ch∆∞a c√≥ kh√°ch h√†ng n√†o</td></tr>';
}

function displaySuppliers() {
    const tbody = document.getElementById('suppliers-table-body');
    if (!tbody) return;
    
    tbody.innerHTML = '<tr><td colspan="5" class="text-center" style="padding: 40px; color: #666;">Ch∆∞a c√≥ nh√† cung c·∫•p n√†o</td></tr>';
}

// =================== UI HELPER FUNCTIONS ===================
function toggleUserMenu() {
    const dropdown = document.getElementById('user-dropdown');
    if (dropdown) {
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        
        // Close dropdown when clicking outside
        setTimeout(() => {
            document.addEventListener('click', function closeDropdown(e) {
                if (!e.target.closest('#user-menu-toggle') && !e.target.closest('#user-dropdown')) {
                    dropdown.style.display = 'none';
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }, 0);
    }
}

function showNotification(message, type = 'info') {
    console.log(`üì¢ Notification (${type}):`, message);
    
    // Remove existing notification
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // Create new notification
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas ${getNotificationIcon(type)}"></i>
            <span>${message}</span>
        </div>
    `;
    
    // Add to body
    document.body.appendChild(notification);
    
    // Show notification
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);
    
    // Auto hide after 3 seconds
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    }, 3000);
}

function getNotificationIcon(type) {
    const icons = {
        'success': 'fa-check-circle',
        'error': 'fa-times-circle',  
        'warning': 'fa-exclamation-triangle',
        'info': 'fa-info-circle'
    };
    return icons[type] || icons.info;
}

function updateElement(id, content) {
    const element = document.getElementById(id);
    if (element) {
        element.textContent = content;
    }
}

// =================== UTILITY FUNCTIONS ===================
function formatCurrency(amount) {
    if (amount === null || amount === undefined || isNaN(amount)) return '0 VND';
    
    return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    
    const date = new Date(dateStr);
    return date.toLocaleDateString('vi-VN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    });
}

// =================== PLACEHOLDER FUNCTIONS ===================
function editTransaction(id) {
    showNotification('Ch·ª©c nƒÉng s·ª≠a giao d·ªãch ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
}

function deleteTransaction(id) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a giao d·ªãch n√†y?')) {
        return;
    }
    
    showLoading('ƒêang x√≥a giao d·ªãch...');
    
    google.script.run
        .withSuccessHandler(function(result) {
            hideLoading();
            
            if (result.success) {
                // Reload data
                loadDashboardData();
                if (currentPage === 'transactions') {
                    loadPageData('transactions');
                }
                showNotification('X√≥a giao d·ªãch th√†nh c√¥ng!', 'success');
            } else {
                showNotification('L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ x√≥a giao d·ªãch'), 'error');
            }
        })
        .withFailureHandler(function(error) {
            hideLoading();
            console.error('‚ùå Error deleting transaction:', error);
            showNotification('C√≥ l·ªói x·∫£y ra khi x√≥a giao d·ªãch', 'error');
        })
        .deleteTransaction(id);
}

function editCategory(id) {
    showNotification('Ch·ª©c nƒÉng s·ª≠a danh m·ª•c ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
}

function deleteCategory(id) {
    showNotification('Ch·ª©c nƒÉng x√≥a danh m·ª•c ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
}

// =================== DEBUG HELPERS ===================
window.NHTFinance = {
    currentUser,
    currentPage,
    accounts,
    categories,
    transactions,
    customers,
    suppliers,
    debug: {
        showData: () => {
            console.log('=== NHT Finance Debug Info ===');
            console.log('Current User:', currentUser);
            console.log('Current Page:', currentPage);
            console.log('Accounts:', accounts);
            console.log('Categories:', categories);
            console.log('Transactions:', transactions);
            console.log('Customers:', customers);
            console.log('Suppliers:', suppliers);
        },
        testNotification: (message, type) => {
            showNotification(message || 'Test notification', type || 'info');
        },
        testModal: () => {
            showAddTransactionModal();
        }
    }
};

console.log('üéâ NHT Finance System loaded successfully!');
console.log('üìã Use NHTFinance.debug.showData() to view current data');
console.log('üß™ Use NHTFinance.debug.testNotification() to test notifications');
console.log('ü™ü Use NHTFinance.debug.testModal() to test transaction modal');
</script>
