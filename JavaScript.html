<!-- JavaScript.html - COMPLETE FIX -->
<script>
// =================== GLOBAL VARIABLES ===================
let currentUser = null;
let currentPage = 'dashboard';
let accounts = [];
let categories = [];
let transactions = [];
let customers = [];
let suppliers = [];

// =================== INITIALIZATION ===================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM loaded, initializing NHT Finance System...');
    
    // Wait a bit for all HTML to be fully rendered
    setTimeout(() => {
        try {
            initializeSystem();
        } catch (error) {
            console.error('‚ùå Critical error during initialization:', error);
            showCriticalError(error);
        }
    }, 100);
});

function initializeSystem() {
    console.log('üîß Initializing system...');
    
    // Check DOM elements
    checkDOMElements();
    
    // Initialize event listeners
    initializeEventListeners();
    
    // Check authentication status
    checkAuthStatus();
    
    console.log('‚úÖ System initialized successfully');
}

function checkDOMElements() {
    const requiredElements = [
        'login-modal',
        'login-form', 
        'login-username',
        'login-password',
        'login-error'
    ];
    
    const missingElements = [];
    
    requiredElements.forEach(id => {
        const element = document.getElementById(id);
        if (!element) {
            missingElements.push(id);
        }
    });
    
    if (missingElements.length > 0) {
        console.error('‚ùå Missing DOM elements:', missingElements);
        console.log('üîç Available elements with IDs:');
        document.querySelectorAll('[id]').forEach(el => {
            console.log('- ' + el.id);
        });
    } else {
        console.log('‚úÖ All required DOM elements found');
    }
}

// =================== AUTHENTICATION ===================
function handleLogin(event) {
    if (event) event.preventDefault();
    
    console.log('üîê Handling login...');
    
    const usernameField = document.getElementById('login-username');
    const passwordField = document.getElementById('login-password');
    const errorElement = document.getElementById('login-error');
    
    if (!usernameField || !passwordField) {
        console.error('‚ùå Login fields not found!');
        alert('L·ªói: Kh√¥ng t√¨m th·∫•y form ƒëƒÉng nh·∫≠p. Vui l√≤ng reload trang.');
        return;
    }
    
    const username = usernameField.value.trim();
    const password = passwordField.value.trim();
    
    // Clear previous error
    if (errorElement) {
        errorElement.style.display = 'none';
        errorElement.textContent = '';
    }
    
    // Validate inputs
    if (!username || !password) {
        showLoginError('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n ƒëƒÉng nh·∫≠p v√† m·∫≠t kh·∫©u');
        return;
    }
    
    // Show loading
    showLoading('ƒêang x√°c th·ª±c t√†i kho·∫£n...');
    
    // Check if Google Apps Script is available
    if (typeof google !== 'undefined' && google.script && google.script.run) {
        console.log('üì° Using Google Apps Script authentication');
        authenticateWithGoogleScript(username, password);
    } else {
        console.log('‚ö†Ô∏è Google Apps Script not available, using offline mode');
        authenticateOffline(username, password);
    }
}

function authenticateWithGoogleScript(username, password) {
    google.script.run
        .withSuccessHandler(function(result) {
            hideLoading();
            handleAuthResult(result);
        })
        .withFailureHandler(function(error) {
            hideLoading();
            console.error('‚ùå Google Script auth error:', error);
            showLoginError('L·ªói server. Chuy·ªÉn sang ch·∫ø ƒë·ªô offline...');
            setTimeout(() => authenticateOffline(username, password), 1000);
        })
        .authenticateUser(username, password);
}

function authenticateOffline(username, password) {
    console.log('üîÑ Using offline authentication');
    
    // Demo accounts for testing
    const demoAccounts = {
        'admin': { 
            password: 'admin123', 
            fullName: 'Administrator', 
            role: 'ADMIN',
            email: 'admin@nht.com',
            id: 'USER000001'
        },
        'user': { 
            password: 'user123', 
            fullName: 'Demo User', 
            role: 'USER',
            email: 'user@nht.com',
            id: 'USER000002'
        },
        'manager': { 
            password: 'manager123', 
            fullName: 'Manager', 
            role: 'MANAGER',
            email: 'manager@nht.com',
            id: 'USER000003'
        }
    };
    
    setTimeout(() => {
        hideLoading();
        
        if (demoAccounts[username] && demoAccounts[username].password === password) {
            const result = {
                success: true,
                user: demoAccounts[username]
            };
            handleAuthResult(result);
        } else {
            showLoginError('T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng');
        }
    }, 800);
}

function handleAuthResult(result) {
    if (result && result.success && result.user) {
        console.log('‚úÖ Login successful for user:', result.user.username || result.user.fullName);
        
        // Save user data
        currentUser = result.user;
        
        // Save to sessionStorage
        try {
            sessionStorage.setItem('nht_current_user', JSON.stringify(currentUser));
            console.log('‚úÖ User saved to sessionStorage');
        } catch (storageError) {
            console.warn('‚ö†Ô∏è SessionStorage not available');
        }
        
        // Hide login modal and initialize app
        hideLoginModal();
        initializeApp();
        
    } else {
        console.log('‚ùå Login failed:', result?.message);
        showLoginError(result?.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i');
    }
}

function checkAuthStatus() {
    console.log('üîç Checking authentication status...');
    
    try {
        const savedUser = sessionStorage.getItem('nht_current_user');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            console.log('‚úÖ User found in sessionStorage:', currentUser);
            hideLoginModal();
            initializeApp();
            return;
        }
    } catch (error) {
        console.warn('‚ö†Ô∏è Error reading sessionStorage:', error);
    }
    
    console.log('‚ÑπÔ∏è No saved user, showing login modal');
    showLoginModal();
}

function handleLogout() {
    console.log('üö™ Logging out...');
    
    currentUser = null;
    
    try {
        sessionStorage.removeItem('nht_current_user');
    } catch (e) {
        console.warn('SessionStorage not available');
    }
    
    // Reset data
    transactions = [];
    accounts = [];
    categories = [];
    customers = [];
    suppliers = [];
    
    // Show login modal
    showLoginModal();
    showNotification('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!', 'info');
}

// =================== APP INITIALIZATION ===================
function initializeApp() {
    console.log('üéØ Initializing app for user:', currentUser?.fullName || currentUser?.username);
    
    try {
        updateUserDisplay();
        loadDashboardData();
        showNotification('ƒêƒÉng nh·∫≠p th√†nh c√¥ng! Ch√†o m·ª´ng ' + (currentUser?.fullName || currentUser?.username), 'success');
    } catch (error) {
        console.error('‚ùå Error initializing app:', error);
        showNotification('C√≥ l·ªói khi kh·ªüi t·∫°o ·ª©ng d·ª•ng', 'error');
    }
}

function updateUserDisplay() {
    if (!currentUser) return;
    
    try {
        const usernameDisplay = document.getElementById('username-display');
        if (usernameDisplay) {
            usernameDisplay.textContent = currentUser.fullName || currentUser.username;
        }
        
        const userAvatar = document.getElementById('user-avatar');
        if (userAvatar) {
            const firstLetter = (currentUser.fullName || currentUser.username).charAt(0).toUpperCase();
            userAvatar.textContent = firstLetter;
        }
        
        console.log('‚úÖ User display updated');
    } catch (error) {
        console.error('‚ùå Error updating user display:', error);
    }
}

// =================== EVENT LISTENERS ===================
function initializeEventListeners() {
    console.log('üîó Setting up event listeners...');
    
    try {
        // Login form
        const loginForm = document.getElementById('login-form');
        if (loginForm) {
            loginForm.addEventListener('submit', handleLogin);
            console.log('‚úÖ Login form event listener added');
        } else {
            console.warn('‚ö†Ô∏è Login form not found');
        }
        
        // Enter key support
        const usernameField = document.getElementById('login-username');
        const passwordField = document.getElementById('login-password');
        
        if (usernameField) {
            usernameField.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && passwordField) {
                    passwordField.focus();
                }
            });
        }
        
        if (passwordField) {
            passwordField.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleLogin(e);
                }
            });
        }
        
        // Navigation
        initializeNavigationListeners();
        
        // Modals
        initializeModalListeners();
        
        // Forms
        initializeFormListeners();
        
        console.log('‚úÖ All event listeners set up');
        
    } catch (error) {
        console.error('‚ùå Error setting up event listeners:', error);
    }
}

function initializeNavigationListeners() {
    // Sidebar navigation
    document.querySelectorAll('.sidebar-menu li').forEach(item => {
        item.addEventListener('click', function() {
            const page = this.getAttribute('data-page');
            if (page) {
                changePage(page);
            }
        });
    });
    
    // Sidebar collapse
    const collapseBtn = document.getElementById('collapse-sidebar');
    if (collapseBtn) {
        collapseBtn.addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('collapsed');
            }
        });
    }
    
    // User menu
    const userMenuToggle = document.getElementById('user-menu-toggle');
    if (userMenuToggle) {
        userMenuToggle.addEventListener('click', toggleUserMenu);
    }
    
    // Logout
    const logoutBtn = document.getElementById('logout-button');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
    }
}

function initializeModalListeners() {
    // Close buttons
    document.querySelectorAll('.close, .cancel-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal && modal.id !== 'login-modal') {
                hideModal(modal.id);
            }
        });
    });
    
    // Click outside modal
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal') && event.target.id !== 'login-modal') {
            hideModal(event.target.id);
        }
    });
}

function initializeFormListeners() {
    // Add transaction button
    const addTransactionBtn = document.getElementById('add-transaction-btn');
    if (addTransactionBtn) {
        addTransactionBtn.addEventListener('click', showAddTransactionModal);
    }
    
    // Transaction form
    const transactionForm = document.getElementById('transaction-form');
    if (transactionForm) {
        transactionForm.addEventListener('submit', handleTransactionSubmit);
    }
    
    // Other form listeners...
}

// =================== MODAL FUNCTIONS ===================
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

function showLoginModal() {
    const modal = document.getElementById('login-modal');
    if (modal) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        // Focus username field
        setTimeout(() => {
            const usernameField = document.getElementById('login-username');
            if (usernameField) {
                usernameField.focus();
            }
        }, 100);
    }
}

function hideLoginModal() {
    const modal = document.getElementById('login-modal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
        console.log('‚úÖ Login modal hidden');
    }
}

function showLoginError(message) {
    const errorElement = document.getElementById('login-error');
    if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        
        // Shake animation
        errorElement.style.animation = 'shake 0.5s ease-in-out';
        setTimeout(() => {
            if (errorElement) {
                errorElement.style.animation = '';
            }
        }, 500);
    }
    console.warn('Login error:', message);
}

// =================== LOADING FUNCTIONS ===================
function showLoading(message = 'ƒêang t·∫£i...') {
    const overlay = document.getElementById('loading-overlay');
    const messageElement = document.getElementById('loading-message');
    
    if (overlay) {
        overlay.style.display = 'flex';
        if (messageElement) {
            messageElement.textContent = message;
        }
    }
}

function hideLoading() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

// =================== NAVIGATION ===================
function changePage(pageId) {
    console.log('üìÑ Changing to page:', pageId);
    
    // Update sidebar
    document.querySelectorAll('.sidebar-menu li').forEach(item => {
        item.classList.remove('active');
    });
    const activeItem = document.querySelector(`[data-page="${pageId}"]`);
    if (activeItem) {
        activeItem.classList.add('active');
    }
    
    // Show page
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.classList.add('active');
    }
    
    // Update title
    const titles = {
        'dashboard': 'Dashboard',
        'transactions': 'Qu·∫£n l√Ω giao d·ªãch',
        'accounts': 'Qu·∫£n l√Ω t√†i kho·∫£n',
        'categories': 'Qu·∫£n l√Ω danh m·ª•c',
        'customers': 'Qu·∫£n l√Ω kh√°ch h√†ng',
        'suppliers': 'Qu·∫£n l√Ω nh√† cung c·∫•p'
    };
    
    const pageTitle = document.getElementById('page-title');
    if (pageTitle) {
        pageTitle.textContent = titles[pageId] || 'Dashboard';
    }
    
    currentPage = pageId;
    loadPageData(pageId);
}

function loadPageData(pageId) {
    switch(pageId) {
        case 'dashboard':
            loadDashboardData();
            break;
        case 'transactions':
            displayTransactions();
            break;
        case 'accounts':
            displayAccounts();
            break;
        default:
            // Load page specific data
            break;
    }
}

// =================== DATA FUNCTIONS ===================
function loadDashboardData() {
    console.log('üìä Loading dashboard data...');
    
    if (typeof google !== 'undefined' && google.script && google.script.run) {
        loadRealData();
    } else {
        loadSampleData();
    }
}

function loadRealData() {
    // Implementation for real Google Apps Script data
    console.log('üì° Loading real data from Google Apps Script...');
    showNotification('T√≠nh nƒÉng n√†y ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
    loadSampleData();
}

function loadSampleData() {
    console.log('üìã Loading sample data...');
    
    // Sample data for testing
    transactions = [
        {
            id: 'GD000001',
            date: new Date().toLocaleDateString('vi-VN'),
            type: 'Thu',
            category: 'L∆∞∆°ng',
            amount: 15000000,
            account: 'Vietcombank',
            note: 'L∆∞∆°ng th√°ng 12',
            status: 'Ho√†n th√†nh'
        },
        {
            id: 'GD000002',
            date: new Date().toLocaleDateString('vi-VN'),
            type: 'Chi',
            category: 'ƒÇn u·ªëng',
            amount: 500000,
            account: 'Ti·ªÅn m·∫∑t',
            note: 'ƒÇn tr∆∞a',
            status: 'Ho√†n th√†nh'
        }
    ];
    
    accounts = [
        { id: 'TK000001', name: 'Vietcombank', type: 'Ng√¢n h√†ng', balance: 15000000 },
        { id: 'TK000002', name: 'Ti·ªÅn m·∫∑t', type: 'Ti·ªÅn m·∫∑t', balance: 2000000 }
    ];
    
    categories = [
        { id: 'DM000001', name: 'L∆∞∆°ng', type: 'Thu', description: 'L∆∞∆°ng th√°ng' },
        { id: 'DM000002', name: 'ƒÇn u·ªëng', type: 'Chi', description: 'Chi ph√≠ ƒÉn u·ªëng' }
    ];
    
    updateDashboardStats();
    displayRecentTransactions();
    populateDropdowns();
    
    showNotification('D·ªØ li·ªáu m·∫´u ƒë√£ ƒë∆∞·ª£c t·∫£i', 'info');
}

function updateDashboardStats() {
    const totalIncome = transactions
        .filter(t => t.type === 'Thu')
        .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
    
    const totalExpense = transactions
        .filter(t => t.type === 'Chi')
        .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
    
    const netProfit = totalIncome - totalExpense;
    const totalBalance = accounts.reduce((sum, acc) => sum + (parseFloat(acc.balance) || 0), 0);
    
    updateElement('total-income', formatCurrency(totalIncome));
    updateElement('total-expense', formatCurrency(totalExpense));
    updateElement('net-profit', formatCurrency(netProfit));
    updateElement('total-balance', formatCurrency(totalBalance));
}

function displayRecentTransactions() {
    const tbody = document.getElementById('recent-transactions-body');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (!transactions || transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center" style="padding: 40px; color: #666;">Ch∆∞a c√≥ giao d·ªãch n√†o</td></tr>';
        return;
    }
    
    const recent = transactions.slice(0, 5);
    recent.forEach(transaction => {
        const row = document.createElement('tr');
        const amountClass = transaction.type === 'Thu' ? 'income' : 'expense';
        
        row.innerHTML = `
            <td>${formatDate(transaction.date)}</td>
            <td><span class="badge ${transaction.type === 'Thu' ? 'badge-success' : 'badge-danger'}">${transaction.type}</span></td>
            <td class="${amountClass}">${formatCurrency(transaction.amount)}</td>
            <td>${transaction.account}</td>
            <td>${transaction.note || '-'}</td>
        `;
        tbody.appendChild(row);
    });
}

function displayTransactions() {
    const tbody = document.getElementById('transactions-table-body');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (!transactions || transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center" style="padding: 40px; color: #666;">Ch∆∞a c√≥ giao d·ªãch n√†o</td></tr>';
        return;
    }
    
    transactions.forEach(transaction => {
        const row = document.createElement('tr');
        const amountClass = transaction.type === 'Thu' ? 'income' : 'expense';
        
        row.innerHTML = `
            <td><input type="checkbox"></td>
            <td>${transaction.id}</td>
            <td>${formatDate(transaction.date)}</td>
            <td><span class="badge ${transaction.type === 'Thu' ? 'badge-success' : 'badge-danger'}">${transaction.type}</span></td>
            <td>${transaction.category}</td>
            <td class="${amountClass}">${formatCurrency(transaction.amount)}</td>
            <td>${transaction.account}</td>
            <td>${transaction.note || '-'}</td>
            <td><span class="status-completed">Ho√†n th√†nh</span></td>
            <td>
                <button class="btn btn-sm btn-secondary" onclick="editTransaction('${transaction.id}')" title="S·ª≠a">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteTransaction('${transaction.id}')" title="X√≥a">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function displayAccounts() {
    const accountsList = document.getElementById('accounts-list');
    if (!accountsList) return;
    
    if (!accounts || accounts.length === 0) {
        accountsList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Ch∆∞a c√≥ t√†i kho·∫£n n√†o</p>';
        return;
    }
    
    let html = '<div class="stats-grid">';
    accounts.forEach(account => {
        const balanceClass = (account.balance || 0) >= 0 ? 'income' : 'expense';
        html += `
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">${account.name}</div>
                    <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-wallet"></i>
                    </div>
                </div>
                <div class="stat-value ${balanceClass}">${formatCurrency(account.balance || 0)}</div>
                <div class="stat-change">${account.type}</div>
            </div>
        `;
    });
    html += '</div>';
    
    accountsList.innerHTML = html;
}

function populateDropdowns() {
    // Account dropdown
    const accountSelect = document.getElementById('transaction-source-account');
    if (accountSelect) {
        accountSelect.innerHTML = '<option value="">-- Ch·ªçn t√†i kho·∫£n --</option>';
        accounts.forEach(account => {
            const option = document.createElement('option');
            option.value = account.name;
            option.textContent = `${account.name} (${formatCurrency(account.balance || 0)})`;
            accountSelect.appendChild(option);
        });
    }
    
    // Category dropdown
    const categorySelect = document.getElementById('transaction-category');
    if (categorySelect) {
        categorySelect.innerHTML = '<option value="">-- Ch·ªçn danh m·ª•c --</option>';
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.name;
            option.textContent = category.name;
            categorySelect.appendChild(option);
        });
    }
}

// =================== TRANSACTION FUNCTIONS ===================
function showAddTransactionModal() {
    console.log('üí∞ Opening add transaction modal...');
    
    const form = document.getElementById('transaction-form');
    if (form) {
        form.reset();
    }
    
    const dateInput = document.getElementById('transaction-date');
    if (dateInput) {
        dateInput.valueAsDate = new Date();
    }
    
    populateDropdowns();
    showModal('transaction-modal');
}

function handleTransactionSubmit(event) {
    event.preventDefault();
    console.log('üíæ Handling transaction submit...');
    
    const formData = {
        date: document.getElementById('transaction-date').value,
        type: document.getElementById('transaction-type').value,
        category: document.getElementById('transaction-category').value,
        amount: parseFloat(document.getElementById('transaction-amount').value) || 0,
        account: document.getElementById('transaction-source-account').value,
        note: document.getElementById('transaction-note').value || ''
    };
    
    if (!formData.date || !formData.type || !formData.category || formData.amount <= 0 || !formData.account) {
        showNotification('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc', 'error');
        return;
    }
    
    // Generate ID
    const id = 'GD' + String(transactions.length + 1).padStart(6, '0');
    
    // Add to transactions
    transactions.push({
        id: id,
        ...formData,
        status: 'Ho√†n th√†nh'
    });
    
    // Hide modal
    hideModal('transaction-modal');
    
    // Refresh data
    updateDashboardStats();
    displayRecentTransactions();
    if (currentPage === 'transactions') {
        displayTransactions();
    }
    
    showNotification('Th√™m giao d·ªãch th√†nh c√¥ng!', 'success');
}

// =================== UTILITY FUNCTIONS ===================
function toggleUserMenu() {
    const dropdown = document.getElementById('user-dropdown');
    if (dropdown) {
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }
}

function showNotification(message, type = 'info') {
    console.log(`üì¢ ${type.toUpperCase()}: ${message}`);
    
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas ${getNotificationIcon(type)}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    }, 3000);
}

function getNotificationIcon(type) {
    const icons = {
        'success': 'fa-check-circle',
        'error': 'fa-times-circle',
        'warning': 'fa-exclamation-triangle',
        'info': 'fa-info-circle'
    };
    return icons[type] || icons.info;
}

function updateElement(id, content) {
    const element = document.getElementById(id);
    if (element) {
        element.textContent = content;
    }
}

function formatCurrency(amount) {
    if (amount === null || amount === undefined || isNaN(amount)) return '0 VND';
    
    return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    
    const date = new Date(dateStr);
    return date.toLocaleDateString('vi-VN');
}

function showCriticalError(error) {
    const errorHtml = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; font-family: Arial, sans-serif; background: #f8f9fa;">
            <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 500px; text-align: center;">
                <h1 style="color: #dc3545; margin-bottom: 20px;">‚ö†Ô∏è L·ªói kh·ªüi t·∫°o</h1>
                <p style="color: #666; margin-bottom: 20px;">Kh√¥ng th·ªÉ kh·ªüi t·∫°o ·ª©ng d·ª•ng. Vui l√≤ng l√†m m·ªõi trang.</p>
                <button onclick="window.location.reload()" style="padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;">
                    üîÑ L√†m m·ªõi trang
                </button>
                <details style="margin-top: 20px; text-align: left;">
                    <summary style="cursor: pointer; color: #666;">Chi ti·∫øt l·ªói</summary>
                    <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 12px; margin-top: 10px; overflow: auto;">${error.message || error}</pre>
                </details>
            </div>
        </div>
    `;
    
    document.body.innerHTML = errorHtml;
}

// =================== PLACEHOLDER FUNCTIONS ===================
function editTransaction(id) {
    showNotification('Ch·ª©c nƒÉng s·ª≠a giao d·ªãch ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
}

function deleteTransaction(id) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a giao d·ªãch n√†y?')) {
        return;
    }
    
    // Find and remove transaction
    const index = transactions.findIndex(t => t.id === id);
    if (index !== -1) {
        transactions.splice(index, 1);
        
        // Refresh displays
        updateDashboardStats();
        displayRecentTransactions();
        if (currentPage === 'transactions') {
            displayTransactions();
        }
        
        showNotification('X√≥a giao d·ªãch th√†nh c√¥ng!', 'success');
    } else {
        showNotification('Kh√¥ng t√¨m th·∫•y giao d·ªãch!', 'error');
    }
}

// =================== DEBUGGING UTILITIES ===================
window.NHTFinance = {
    currentUser,
    currentPage,
    accounts,
    categories,
    transactions,
    customers,
    suppliers,
    debug: {
        showData: () => {
            console.log('=== NHT Finance Debug Info ===');
            console.log('Current User:', currentUser);
            console.log('Current Page:', currentPage);
            console.log('Accounts:', accounts);
            console.log('Categories:', categories);
            console.log('Transactions:', transactions);
            console.log('Customers:', customers);
            console.log('Suppliers:', suppliers);
        },
        testNotification: (message, type) => {
            showNotification(message || 'Test notification', type || 'info');
        },
        testModal: () => {
            showAddTransactionModal();
        },
        testLogin: (username, password) => {
            document.getElementById('login-username').value = username || 'admin';
            document.getElementById('login-password').value = password || 'admin123';
            handleLogin();
        },
        checkElements: () => {
            checkDOMElements();
        }
    }
};

// =================== ERROR HANDLING ===================
window.addEventListener('error', function(event) {
    console.error('üí• Global JavaScript error:', {
        message: event.message,
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno,
        error: event.error
    });
    showNotification('ƒê√£ x·∫£y ra l·ªói h·ªá th·ªëng. Vui l√≤ng l√†m m·ªõi trang.', 'error');
});

window.addEventListener('unhandledrejection', function(event) {
    console.error('üí• Unhandled promise rejection:', event.reason);
    showNotification('ƒê√£ x·∫£y ra l·ªói h·ªá th·ªëng. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
});

// =================== READY STATE ===================
console.log('üéâ NHT Finance System JavaScript loaded successfully!');
console.log('üìã Use NHTFinance.debug.showData() to view current data');
console.log('üß™ Use NHTFinance.debug.testNotification() to test notifications');
console.log('ü™ü Use NHTFinance.debug.testModal() to test transaction modal');
console.log('üîë Use NHTFinance.debug.testLogin() to test login');
console.log('üîç Use NHTFinance.debug.checkElements() to check DOM elements');
</script>
