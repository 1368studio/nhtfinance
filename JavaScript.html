<!-- JavaScript.html - UPDATED FOR YOUR EXCEL STRUCTURE -->
<script>
// =================== GLOBAL VARIABLES ===================
let currentUser = null;
let currentPage = 'dashboard';
let accounts = [];
let categories = [];
let transactions = [];
let customers = [];
let suppliers = [];

// =================== SIMPLE AUTHENTICATION ===================
function simpleLogin() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value.trim();
  
  // Clear previous error
  hideLoginError();
  
  // Validate input
  if (!username || !password) {
    showLoginError('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
    return;
  }
  
  // Show loading
  showLoading('ƒêang ki·ªÉm tra th√¥ng tin...');
  
  // Call Google Apps Script
  google.script.run
    .withSuccessHandler(handleLoginSuccess)
    .withFailureHandler(handleLoginError)
    .checkLogin(username, password);
}

function handleLoginSuccess(result) {
  hideLoading();
  
  if (result.success) {
    // Save user info
    currentUser = result.user;
    
    // Hide login modal
    document.getElementById('login-modal').style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // Update UI
    updateUserDisplay();
    
    // Load app data
    loadAppData();
    
    // Show success message
    showNotification(`Ch√†o m·ª´ng ${currentUser.fullName || currentUser.username}!`, 'success');
    
    console.log('‚úÖ Login success:', currentUser);
  } else {
    showLoginError(result.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i');
  }
}

function handleLoginError(error) {
  hideLoading();
  showLoginError('L·ªói k·∫øt n·ªëi: ' + error.message);
  console.error('Login error:', error);
}

function updateUserDisplay() {
  if (!currentUser) return;
  
  // Update username display
  const usernameDisplay = document.getElementById('username-display');
  if (usernameDisplay) {
    usernameDisplay.textContent = currentUser.fullName || currentUser.username;
  }
  
  // Update avatar
  const userAvatar = document.getElementById('user-avatar');
  if (userAvatar) {
    const firstLetter = (currentUser.fullName || currentUser.username).charAt(0).toUpperCase();
    userAvatar.textContent = firstLetter;
  }
}

function simpleLogout() {
  currentUser = null;
  
  // Show login modal
  document.getElementById('login-modal').style.display = 'block';
  document.body.style.overflow = 'hidden';
  
  // Clear form
  document.getElementById('login-username').value = '';
  document.getElementById('login-password').value = '';
  hideLoginError();
  
  // Reset data
  transactions = [];
  accounts = [];
  categories = [];
  customers = [];
  suppliers = [];
  
  showNotification('ƒê√£ ƒëƒÉng xu·∫•t!', 'info');
  console.log('üëã Logged out');
}

function requireLogin() {
  if (!currentUser) {
    showNotification('Vui l√≤ng ƒëƒÉng nh·∫≠p!', 'warning');
    return false;
  }
  return true;
}

// =================== DATA LOADING ===================
function loadAppData() {
  showLoading('ƒêang t·∫£i d·ªØ li·ªáu...');
  
  google.script.run
    .withSuccessHandler(function(data) {
      hideLoading();
      
      // Save data to global variables
      transactions = data.transactions || [];
      accounts = data.accounts || [];
      categories = data.categories || [];
      customers = data.customers || [];
      suppliers = data.suppliers || [];
      
      console.log('üìä Data loaded:');
      console.log('- Transactions:', transactions.length);
      console.log('- Accounts:', accounts.length);
      console.log('- Categories:', categories.length);
      console.log('- Customers:', customers.length);
      console.log('- Suppliers:', suppliers.length);
      
      // Update UI
      updateDashboardStats();
      displayRecentTransactions();
      populateDropdowns();
      
      console.log('‚úÖ App data loaded successfully');
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showNotification('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
      console.error('Load data error:', error);
    })
    .getAllData();
}

// =================== UTILITY FUNCTIONS ===================
function showLoginError(message) {
  const errorEl = document.getElementById('login-error');
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    
    // Shake animation
    const form = document.getElementById('login-form');
    if (form) {
      form.style.animation = 'shake 0.5s ease-in-out';
      setTimeout(() => form.style.animation = '', 500);
    }
  }
}

function hideLoginError() {
  const errorEl = document.getElementById('login-error');
  if (errorEl) {
    errorEl.style.display = 'none';
  }
}

function showLoading(message = 'ƒêang x·ª≠ l√Ω...') {
  const overlay = document.getElementById('loading-overlay');
  const messageEl = document.getElementById('loading-message');
  
  if (overlay) {
    overlay.style.display = 'flex';
    if (messageEl) messageEl.textContent = message;
  }
}

function hideLoading() {
  const overlay = document.getElementById('loading-overlay');
  if (overlay) {
    overlay.style.display = 'none';
  }
}

function showNotification(message, type = 'info') {
  const colors = {
    success: '#28a745',
    error: '#dc3545', 
    warning: '#ffc107',
    info: '#17a2b8'
  };
  
  const icons = {
    success: '‚úÖ',
    error: '‚ùå',
    warning: '‚ö†Ô∏è', 
    info: '‚ÑπÔ∏è'
  };
  
  // Remove existing notification
  const existing = document.querySelector('.temp-notification');
  if (existing) existing.remove();
  
  // Create notification
  const notification = document.createElement('div');
  notification.className = 'temp-notification';
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${colors[type]};
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    font-weight: 500;
    z-index: 10000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: slideIn 0.3s ease;
  `;
  notification.innerHTML = `${icons[type]} ${message}`;
  
  document.body.appendChild(notification);
  
  // Auto remove
  setTimeout(() => notification.remove(), 3000);
  
  console.log(icons[type], message);
}

// =================== NAVIGATION ===================
function changePage(pageId) {
  console.log('üìÑ Changing to page:', pageId);
  
  if (!requireLogin()) return;
  
  // Update sidebar
  document.querySelectorAll('.sidebar-menu li').forEach(item => {
    item.classList.remove('active');
  });
  const activeItem = document.querySelector(`[data-page="${pageId}"]`);
  if (activeItem) {
    activeItem.classList.add('active');
  }
  
  // Show page
  document.querySelectorAll('.page').forEach(page => {
    page.classList.remove('active');
  });
  const targetPage = document.getElementById(pageId);
  if (targetPage) {
    targetPage.classList.add('active');
  }
  
  // Update title
  const titles = {
    'dashboard': 'Dashboard',
    'transactions': 'Qu·∫£n l√Ω giao d·ªãch',
    'accounts': 'Qu·∫£n l√Ω t√†i kho·∫£n',
    'categories': 'Qu·∫£n l√Ω danh m·ª•c',
    'customers': 'Qu·∫£n l√Ω kh√°ch h√†ng',
    'suppliers': 'Qu·∫£n l√Ω nh√† cung c·∫•p',
    'users': 'Qu·∫£n l√Ω ng∆∞·ªùi d√πng',
    'reports': 'B√°o c√°o',
    'settings': 'C√†i ƒë·∫∑t'
  };
  
  const pageTitle = document.getElementById('page-title');
  if (pageTitle) {
    pageTitle.textContent = titles[pageId] || 'Dashboard';
  }
  
  currentPage = pageId;
  loadPageData(pageId);
}

function loadPageData(pageId) {
  switch(pageId) {
    case 'dashboard':
      updateDashboardStats();
      displayRecentTransactions();
      break;
    case 'transactions':
      displayTransactions();
      break;
    case 'accounts':
      displayAccounts();
      break;
    case 'categories':
      displayCategories();
      break;
    case 'customers':
      displayCustomers();
      break;
    case 'suppliers':
      displaySuppliers();
      break;
    default:
      break;
  }
}

// =================== DASHBOARD FUNCTIONS - FIXED FOR YOUR DATA ===================
function updateDashboardStats() {
  console.log('üìä Updating dashboard stats...');
  console.log('Transactions data:', transactions);
  console.log('Accounts data:', accounts);
  
  // T√≠nh t·ªïng thu nh·∫≠p (Doanh thu)
  const totalIncome = transactions
    .filter(t => t.type === 'Doanh thu' || t.type === 'Thu')
    .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
  
  // T√≠nh t·ªïng chi ph√≠ (Chi ph√≠)
  const totalExpense = transactions
    .filter(t => t.type === 'Chi ph√≠' || t.type === 'Chi')
    .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
  
  const netProfit = totalIncome - totalExpense;
  
  // T√≠nh t·ªïng s·ªë d∆∞ t·ª´ "S·ªë d∆∞ hi·ªán t·∫°i" c·ªßa accounts
  const totalBalance = accounts.reduce((sum, acc) => sum + (parseFloat(acc.balance) || 0), 0);
  
  console.log('üí∞ Stats calculated:');
  console.log('- Total Income:', totalIncome);
  console.log('- Total Expense:', totalExpense);
  console.log('- Net Profit:', netProfit);
  console.log('- Total Balance:', totalBalance);
  
  updateElement('total-income', formatCurrency(totalIncome));
  updateElement('total-expense', formatCurrency(totalExpense));
  updateElement('net-profit', formatCurrency(netProfit));
  updateElement('total-balance', formatCurrency(totalBalance));
  
  // Update profit color
  const profitElement = document.getElementById('net-profit');
  if (profitElement) {
    profitElement.className = netProfit >= 0 ? 'stat-value income' : 'stat-value expense';
  }
}

function displayRecentTransactions() {
  const tbody = document.getElementById('recent-transactions-body');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  if (!transactions || transactions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-center" style="padding: 40px; color: #666;">Ch∆∞a c√≥ giao d·ªãch n√†o</td></tr>';
    return;
  }
  
  // L·∫•y 5 giao d·ªãch g·∫ßn nh·∫•t
  const recent = transactions.slice(0, 5);
  recent.forEach(transaction => {
    const row = document.createElement('tr');
    const amountClass = (transaction.type === 'Doanh thu' || transaction.type === 'Thu') ? 'income' : 'expense';
    
    row.innerHTML = `
      <td>${formatDate(transaction.date)}</td>
      <td><span class="badge ${(transaction.type === 'Doanh thu' || transaction.type === 'Thu') ? 'badge-success' : 'badge-danger'}">${transaction.type}</span></td>
      <td class="${amountClass}">${formatCurrency(transaction.amount)}</td>
      <td>${transaction.account || '-'}</td>
      <td>${transaction.note || '-'}</td>
    `;
    tbody.appendChild(row);
  });
}

// =================== TRANSACTION FUNCTIONS - FIXED FOR YOUR DATA ===================
function displayTransactions() {
  const tbody = document.getElementById('transactions-table-body');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  if (!transactions || transactions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="10" class="text-center" style="padding: 40px; color: #666;">Ch∆∞a c√≥ giao d·ªãch n√†o</td></tr>';
    return;
  }
  
  transactions.forEach(transaction => {
    const row = document.createElement('tr');
    const amountClass = (transaction.type === 'Doanh thu' || transaction.type === 'Thu') ? 'income' : 'expense';
    
    row.innerHTML = `
      <td><input type="checkbox"></td>
      <td>${transaction.id}</td>
      <td>${formatDate(transaction.date)}</td>
      <td><span class="badge ${(transaction.type === 'Doanh thu' || transaction.type === 'Thu') ? 'badge-success' : 'badge-danger'}">${transaction.type}</span></td>
      <td>${transaction.category || '-'}</td>
      <td class="${amountClass}">${formatCurrency(transaction.amount)}</td>
      <td>${transaction.account || '-'}</td>
      <td>${transaction.note || '-'}</td>
      <td><span class="status-${transaction.status === 'ƒê√£ thanh to√°n' ? 'completed' : 'pending'}">${transaction.status || 'Ch∆∞a thanh to√°n'}</span></td>
      <td>
        <button class="btn btn-sm btn-secondary" onclick="editTransaction('${transaction.id}')" title="S·ª≠a">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-danger" onclick="deleteTransaction('${transaction.id}')" title="X√≥a">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function showAddTransactionModal() {
  if (!requireLogin()) return;
  
  console.log('üí∞ Opening add transaction modal...');
  
  const form = document.getElementById('transaction-form');
  if (form) {
    form.reset();
  }
  
  const dateInput = document.getElementById('transaction-date');
  if (dateInput) {
    dateInput.valueAsDate = new Date();
  }
  
  populateDropdowns();
  showModal('transaction-modal');
}

function handleTransactionSubmit(event) {
  event.preventDefault();
  
  if (!requireLogin()) return;
  
  console.log('üíæ Handling transaction submit...');
  
  const formData = {
    date: document.getElementById('transaction-date').value,
    type: document.getElementById('transaction-type').value,
    category: document.getElementById('transaction-category').value,
    amount: parseFloat(document.getElementById('transaction-amount').value) || 0,
    account: document.getElementById('transaction-source-account').value,
    note: document.getElementById('transaction-note').value || ''
  };
  
  if (!formData.date || !formData.type || !formData.category || formData.amount <= 0 || !formData.account) {
    showNotification('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc', 'error');
    return;
  }
  
  showLoading('ƒêang l∆∞u giao d·ªãch...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result.success) {
        hideModal('transaction-modal');
        loadAppData(); // Reload all data
        showNotification('Th√™m giao d·ªãch th√†nh c√¥ng!', 'success');
      } else {
        showNotification(result.message || 'L·ªói khi th√™m giao d·ªãch', 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showNotification('L·ªói server: ' + error.message, 'error');
    })
    .addTransaction(formData);
}

// =================== DISPLAY FUNCTIONS - FIXED FOR YOUR DATA ===================
function displayAccounts() {
  const accountsList = document.getElementById('accounts-list');
  if (!accountsList) return;
  
  if (!accounts || accounts.length === 0) {
    accountsList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Ch∆∞a c√≥ t√†i kho·∫£n n√†o</p>';
    return;
  }
  
  let html = '<div class="stats-grid">';
  accounts.forEach(account => {
    const balanceClass = (account.balance || 0) >= 0 ? 'income' : 'expense';
    html += `
      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-title">${account.name}</div>
          <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            ${account.icon || '<i class="fas fa-wallet"></i>'}
          </div>
        </div>
        <div class="stat-value ${balanceClass}">${formatCurrency(account.balance || 0)}</div>
        <div class="stat-change">${account.type} ${account.accountNumber ? '‚Ä¢ ' + account.accountNumber : ''}</div>
      </div>
    `;
  });
  html += '</div>';
  
  accountsList.innerHTML = html;
}

function displayCategories() {
  const tbody = document.getElementById('categories-table-body');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  if (!categories || categories.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-center" style="padding: 40px; color: #666;">Ch∆∞a c√≥ danh m·ª•c n√†o</td></tr>';
    return;
  }
  
  categories.forEach(category => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${category.id}</td>
      <td>${category.icon || 'üìÅ'} ${category.name}</td>
      <td><span class="badge ${category.type === 'Doanh thu' ? 'badge-success' : 'badge-danger'}">${category.type}</span></td>
      <td>${category.description || '-'}</td>
      <td>
        <button class="btn btn-sm btn-secondary" onclick="editCategory('${category.id}')" title="S·ª≠a">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-danger" onclick="deleteCategory('${category.id}')" title="X√≥a">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function displayCustomers() {
  const tbody = document.getElementById('customers-table-body');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  if (!customers || customers.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center" style="padding: 40px; color: #666;">Ch∆∞a c√≥ kh√°ch h√†ng n√†o</td></tr>';
    return;
  }
  
  customers.forEach(customer => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${customer.id}</td>
      <td>${customer.name}</td>
      <td>${customer.phone || '-'}</td>
      <td>${customer.email || '-'}</td>
      <td>${customer.address || '-'}</td>
      <td>${formatDate(customer.createdDate)}</td>
      <td>
        <button class="btn btn-sm btn-secondary" onclick="editCustomer('${customer.id}')" title="S·ª≠a">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${customer.id}')" title="X√≥a">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function displaySuppliers() {
  const tbody = document.getElementById('suppliers-table-body');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  if (!suppliers || suppliers.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center" style="padding: 40px; color: #666;">Ch∆∞a c√≥ nh√† cung c·∫•p n√†o</td></tr>';
    return;
  }
  
  suppliers.forEach(supplier => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${supplier.id}</td>
      <td>${supplier.name}</td>
      <td>${supplier.phone || '-'}</td>
      <td>${supplier.email || '-'}</td>
      <td>${supplier.address || '-'}</td>
      <td>${formatDate(supplier.createdDate)}</td>
      <td>
        <button class="btn btn-sm btn-secondary" onclick="editSupplier('${supplier.id}')" title="S·ª≠a">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-danger" onclick="deleteSupplier('${supplier.id}')" title="X√≥a">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function populateDropdowns() {
  // Account dropdown - s·ª≠ d·ª•ng t√™n t·ª´ c·∫•u tr√∫c m·ªõi
  const accountSelect = document.getElementById('transaction-source-account');
  if (accountSelect) {
    accountSelect.innerHTML = '<option value="">-- Ch·ªçn t√†i kho·∫£n --</option>';
    accounts.forEach(account => {
      const option = document.createElement('option');
      option.value = account.name;
      option.textContent = `${account.name} (${formatCurrency(account.balance || 0)})`;
      accountSelect.appendChild(option);
    });
  }
  
  // Category dropdown - s·ª≠ d·ª•ng t√™n t·ª´ c·∫•u tr√∫c m·ªõi
  const categorySelect = document.getElementById('transaction-category');
  if (categorySelect) {
    categorySelect.innerHTML = '<option value="">-- Ch·ªçn danh m·ª•c --</option>';
    categories.forEach(category => {
      const option = document.createElement('option');
      option.value = category.name;
      option.textContent = `${category.icon || 'üìÅ'} ${category.name}`;
      categorySelect.appendChild(option);
    });
  }
  
  // Update transaction type options to match your data
  const typeSelect = document.getElementById('transaction-type');
  if (typeSelect) {
    typeSelect.innerHTML = `
      <option value="">-- Ch·ªçn lo·∫°i --</option>
      <option value="Doanh thu">Doanh thu</option>
      <option value="Chi ph√≠">Chi ph√≠</option>
    `;
  }
}

// =================== MODAL FUNCTIONS ===================
function showModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
  }
}

function hideModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
}

// =================== UTILITY FUNCTIONS ===================
function toggleUserMenu() {
  const dropdown = document.getElementById('user-dropdown');
  if (dropdown) {
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
  }
}

function updateElement(id, content) {
  const element = document.getElementById(id);
  if (element) {
    element.textContent = content;
  }
}

function formatCurrency(amount) {
  if (amount === null || amount === undefined || isNaN(amount)) return '0 VND';
  
  return new Intl.NumberFormat('vi-VN', {
    style: 'currency',
    currency: 'VND',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(amount);
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  
  try {
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return dateStr; // Return original if invalid date
    return date.toLocaleDateString('vi-VN');
  } catch (error) {
    return dateStr;
  }
}

// =================== PLACEHOLDER FUNCTIONS ===================
function editTransaction(id) {
  if (!requireLogin()) return;
  showNotification('Ch·ª©c nƒÉng s·ª≠a giao d·ªãch ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
}

function deleteTransaction(id) {
  if (!requireLogin()) return;
  
  if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a giao d·ªãch n√†y?')) {
    return;
  }
  
  showLoading('ƒêang x√≥a giao d·ªãch...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      if (result.success) {
        loadAppData(); // Reload data
        showNotification('X√≥a giao d·ªãch th√†nh c√¥ng!', 'success');
      } else {
        showNotification(result.message || 'L·ªói khi x√≥a giao d·ªãch', 'error');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showNotification('L·ªói server: ' + error.message, 'error');
    })
    .deleteTransaction(id);
}

function editCategory(id) {
  if (!requireLogin()) return;
  showNotification('Ch·ª©c nƒÉng s·ª≠a danh m·ª•c ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
}

function deleteCategory(id) {
  if (!requireLogin()) return;
  showNotification('Ch·ª©c nƒÉng x√≥a danh m·ª•c ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
}

function editCustomer(id) {
  if (!requireLogin()) return;
  showNotification('Ch·ª©c nƒÉng s·ª≠a kh√°ch h√†ng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
}

function deleteCustomer(id) {
  if (!requireLogin()) return;
  showNotification('Ch·ª©c nƒÉng x√≥a kh√°ch h√†ng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
}

function editSupplier(id) {
  if (!requireLogin()) return;
  showNotification('Ch·ª©c nƒÉng s·ª≠a nh√† cung c·∫•p ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
}

function deleteSupplier(id) {
  if (!requireLogin()) return;
  showNotification('Ch·ª©c nƒÉng x√≥a nh√† cung c·∫•p ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
}

// =================== EVENT LISTENERS ===================
function initializeEventListeners() {
  console.log('üîó Setting up event listeners...');
  
  // Login form
  const loginForm = document.getElementById('login-form');
  if (loginForm) {
    loginForm.addEventListener('submit', function(e) {
      e.preventDefault();
      simpleLogin();
    });
  }
  
  // Enter key support
  const passwordField = document.getElementById('login-password');
  if (passwordField) {
    passwordField.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') simpleLogin();
    });
  }
  
  // Navigation
  document.querySelectorAll('.sidebar-menu li').forEach(item => {
    item.addEventListener('click', function() {
      const page = this.getAttribute('data-page');
      if (page) {
        changePage(page);
      }
    });
  });
  
  // Sidebar collapse
  const collapseBtn = document.getElementById('collapse-sidebar');
  if (collapseBtn) {
    collapseBtn.addEventListener('click', function() {
      const sidebar = document.getElementById('sidebar');
      if (sidebar) {
        sidebar.classList.toggle('collapsed');
      }
    });
  }
  
  // User menu
  const userMenuToggle = document.getElementById('user-menu-toggle');
  if (userMenuToggle) {
    userMenuToggle.addEventListener('click', toggleUserMenu);
  }
  
  // Logout
  const logoutBtn = document.getElementById('logout-button');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', simpleLogout);
  }
  
  // Modal close buttons
  document.querySelectorAll('.close, .cancel-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const modal = this.closest('.modal');
      if (modal && modal.id !== 'login-modal') {
        hideModal(modal.id);
      }
    });
  });
  
  // Click outside modal
  window.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal') && event.target.id !== 'login-modal') {
      hideModal(event.target.id);
    }
  });
  
  // Add transaction button
  const addTransactionBtn = document.getElementById('add-transaction-btn');
  if (addTransactionBtn) {
    addTransactionBtn.addEventListener('click', showAddTransactionModal);
  }
  
  // Transaction form
  const transactionForm = document.getElementById('transaction-form');
  if (transactionForm) {
    transactionForm.addEventListener('submit', handleTransactionSubmit);
  }
  
  // Dashboard refresh button
  const refreshBtn = document.getElementById('refresh-dashboard');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', function() {
      if (requireLogin()) {
        loadAppData();
      }
    });
  }
  
  console.log('‚úÖ Event listeners set up');
}

// =================== INITIALIZATION ===================
document.addEventListener('DOMContentLoaded', function() {
  console.log('üöÄ NHT Finance System Loading...');
  
  // Add CSS animations
  const style = document.createElement('style');
  style.textContent = `
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    @keyframes slideIn {
      from { transform: translateX(300px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  `;
  document.head.appendChild(style);
  
  // Initialize event listeners
  initializeEventListeners();
  
  // Focus username field
  setTimeout(() => {
    const usernameField = document.getElementById('login-username');
    if (usernameField) {
      usernameField.focus();
    }
  }, 100);
  
  console.log('‚úÖ NHT Finance System Ready - Fixed for your Excel structure!');
});

// =================== DEBUGGING UTILITIES ===================
window.NHTFinance = {
  currentUser: () => currentUser,
  currentPage: () => currentPage,
  data: {
    accounts: () => accounts,
    categories: () => categories,
    transactions: () => transactions,
    customers: () => customers,
    suppliers: () => suppliers
  },
  debug: {
    testLogin: (username = 'admin', password = 'admin123') => {
      document.getElementById('login-username').value = username;
      document.getElementById('login-password').value = password;
      simpleLogin();
    },
    showData: () => {
      console.log('=== NHT Finance Debug Info ===');
      console.log('Current User:', currentUser);
      console.log('Current Page:', currentPage);
      console.log('üìä Data Summary:');
      console.log('- Transactions:', transactions.length, transactions);
      console.log('- Accounts:', accounts.length, accounts);
      console.log('- Categories:', categories.length, categories);
      console.log('- Customers:', customers.length, customers);
      console.log('- Suppliers:', suppliers.length, suppliers);
    },
    testNotification: (message, type) => {
      showNotification(message || 'Test notification', type || 'info');
    },
    reload: () => {
      if (currentUser) {
        loadAppData();
      } else {
        console.log('Not logged in');
      }
    },
    testDataStructure: () => {
      console.log('üîç Testing data structure...');
      if (transactions.length > 0) {
        console.log('üìä Sample transaction:', transactions[0]);
        console.log('üìä Transaction fields:', Object.keys(transactions[0]));
      }
      if (accounts.length > 0) {
        console.log('üí∞ Sample account:', accounts[0]);
        console.log('üí∞ Account fields:', Object.keys(accounts[0]));
      }
      if (categories.length > 0) {
        console.log('üìÅ Sample category:', categories[0]);
        console.log('üìÅ Category fields:', Object.keys(categories[0]));
      }
    }
  }
};

console.log('üéâ NHT Finance System JavaScript loaded - FIXED FOR YOUR EXCEL STRUCTURE!');
console.log('üß™ Use NHTFinance.debug.testLogin() to test login quickly');
console.log('üìã Use NHTFinance.debug.showData() to view current data');
console.log('üîç Use NHTFinance.debug.testDataStructure() to check data structure');
console.log('üìä Key changes:');
console.log('- Fixed transaction types: "Doanh thu" and "Chi ph√≠"');
console.log('- Fixed account balance field');
console.log('- Updated data mapping for all entities');
</script>
